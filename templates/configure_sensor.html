<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configure Sensor for Node {{ node_id }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .form-container { background-color: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 15px; }
        .back-link { margin-top: 20px; display: inline-block; }
        .message-list { max-height: 200px; overflow-y: auto; margin-bottom: 20px; }
        .message-item { cursor: pointer; padding: 5px; border-bottom: 1px solid #ddd; }
        .message-item:hover { background-color: #f0f0f0; }
        .preview-result { margin-top: 10px; color: green; }
        .preview-error { margin-top: 10px; color: red; }
        .suggestion { color: blue; cursor: pointer; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Configure Custom Sensor for Node {{ node_id }}</h1>

        <!-- Past Messages for Selection -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Select a Sensor Message</h5>
                <div class="message-list">
                    {% for msg in messages %}
                    <div class="message-item" onclick="document.getElementById('selected_message').value = '{{ msg.message }}'; analyzeMessage();">
                        {{ msg.message }} ({{ msg.type.capitalize() }} at {{ msg.time | strftime }})
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sensor Configuration Form -->
        <div class="card">
            <div class="card-body form-container">
                <h5 class="card-title">Sensor Configuration</h5>
                <form method="post">
                    <input type="hidden" name="selected_message" id="selected_message" value="{{ selected_message }}">
                    <div class="mb-3">
                        <label class="form-label">Sensor Name</label>
                        <input type="text" name="sensor_name" class="form-control" id="sensor_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Pattern (Suggested: <span id="suggestions"></span>)</label>
                        <input type="text" name="pattern" class="form-control" id="pattern_input" oninput="previewSensor()" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Value Type</label>
                        <select name="value_type" class="form-control" id="value_type" onchange="updateDeviceClassOptions()">
                            <option value="numeric">Numeric (e.g., 23 from 'Temperature 23')</option>
                            <option value="binary">Binary (e.g., ON/OFF from 'Motion Detected')</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Device Class</label>
                        <select name="device_class" class="form-control" id="device_class" onchange="previewSensor()">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Topic (e.g., 'custom' for custom sensors)</label>
                        <input type="text" name="topic" class="form-control" value="custom" required>
                        <small class="form-text text-muted">Set to 'custom' to match the MQTT topic where sensor data is published (e.g., Mesh/feeds/!435864fc/custom/Test sensor).</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Delay Turn-Off (seconds, 0 for none)</label>
                        <input type="number" name="delay_off" class="form-control" min="0" value="0">
                        <small class="form-text text-muted">Set to enable delayed turn-off after sensor clears (e.g., 30 for 30 seconds). For binary sensors, publishes 'OFF'.</small>
                    </div>
                    <div id="preview_result" class="preview-result"></div>
                    <button type="submit" class="btn btn-primary">Save Sensor</button>
                </form>
            </div>
        </div>

        <!-- Existing Sensors -->
        {% if custom_sensors %}
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Existing Sensors</h5>
                <ul class="list-group">
                    {% for sensor in custom_sensors %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ sensor.sensor_name }} (Pattern: {{ sensor.pattern }}, Value Type: {{ sensor.value_type }}, Device Class: {{ sensor.device_class }}, Delay: {{ sensor.delay_off }}s, Topic: {{ sensor.topic }})
                        <form method="post" style="display:inline;">
                            <input type="hidden" name="remove_sensor" value="{{ sensor.sensor_name }}">
                            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}

        <a href="{{ url_for('node_view', node_id=node_id) }}" class="back-link btn btn-secondary mt-3">Back to Node View</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Define device class options for numeric and binary sensors
        const numericDeviceClasses = {
            "sensor": "Generic Sensor",
            "battery": "Battery (%)",
            "voltage": "Voltage (V)",
            "temperature": "Temperature (°C)",
            "humidity": "Humidity (%)",
            "pressure": "Pressure (hPa)",
            "distance": "Distance (m)",
            "speed": "Speed (km/h)",
            "angle": "Angle (°)",
            "current": "Current (A)",
            "energy": "Energy (kWh)",
            "power": "Power (W)",
            "duration": "Duration (s)",
            "timestamp": "Timestamp",
            "illuminance": "Illuminance (lx)",
            "signal_strength": "Signal Strength (dBm)",
            "power_factor": "Power Factor",
            "apparent_power": "Apparent Power (VA)",
            "reactive_power": "Reactive Power (var)",
            "gas": "Gas (m³)",
            "volume": "Volume (L)",
            "frequency": "Frequency (Hz)",
            "carbon_dioxide": "Carbon Dioxide (ppm)",
            "carbon_monoxide": "Carbon Monoxide (ppm)",
            "nitrogen_dioxide": "Nitrogen Dioxide (ppm)",
            "ozone": "Ozone (ppm)",
            "sulphur_dioxide": "Sulphur Dioxide (ppm)",
            "pm1": "PM1 (µg/m³)",
            "pm10": "PM10 (µg/m³)",
            "pm25": "PM2.5 (µg/m³)",
            "volatile_organic_compounds": "Volatile Organic Compounds (ppb)",
            "nitrogen_monoxide": "Nitrogen Monoxide (ppm)"
        };

        const binaryDeviceClasses = {
            "binary_sensor": "Generic Binary Sensor",
            "battery": "Battery",
            "battery_charging": "Battery Charging",
            "carbon_monoxide": "Carbon Monoxide",
            "cold": "Cold",
            "connectivity": "Connectivity",
            "door": "Door",
            "garage_door": "Garage Door",
            "gas": "Gas",
            "heat": "Heat",
            "light": "Light",
            "lock": "Lock",
            "moisture": "Moisture",
            "motion": "Motion",
            "moving": "Moving",
            "occupancy": "Occupancy",
            "opening": "Opening",
            "plug": "Plug",
            "power": "Power",
            "presence": "Presence",
            "problem": "Problem",
            "running": "Running",
            "safety": "Safety",
            "smoke": "Smoke",
            "sound": "Sound",
            "tamper": "Tamper",
            "update": "Update",
            "vibration": "Vibration",
            "window": "Window"
        };

        function updateDeviceClassOptions() {
            const valueType = document.getElementById('value_type').value;
            const deviceClassSelect = document.getElementById('device_class');
            deviceClassSelect.innerHTML = ''; // Clear existing options

            const deviceClasses = valueType === 'numeric' ? numericDeviceClasses : binaryDeviceClasses;
            for (let key in deviceClasses) {
                const option = document.createElement('option');
                option.value = key;
                option.text = deviceClasses[key];
                deviceClassSelect.appendChild(option);
            }
            previewSensor(); // Update preview after changing options
        }

        function analyzeMessage() {
            const message = document.getElementById('selected_message').value;
            const suggestionsDiv = document.getElementById('suggestions');
            if (!message) {
                suggestionsDiv.innerHTML = '';
                return;
            }
            const words = message.split(/\s+/);
            const suggestions = [];
            for (let i = 0; i < words.length - 1; i++) {
                if (/^[A-Za-z]+$/.test(words[i]) && !isNaN(words[i + 1])) {
                    suggestions.push(words[i]);
                }
            }
            suggestionsDiv.innerHTML = suggestions.map(s => `<span class="suggestion" onclick="document.getElementById('pattern_input').value='${s}'; previewSensor();">${s}</span>`).join(' ');
        }

        function previewSensor() {
            const pattern = document.getElementById('pattern_input').value.trim().toLowerCase();
            const selectedMessage = document.getElementById('selected_message').value;
            const previewDiv = document.getElementById('preview_result');
            const valueType = document.getElementById('value_type').value;
            const deviceClass = document.getElementById('device_class').value;

            if (!selectedMessage) {
                previewDiv.textContent = 'Please select a message.';
                previewDiv.classList.remove('preview-result');
                previewDiv.classList.add('preview-error');
                return;
            }

            if (!pattern) {
                previewDiv.textContent = 'Please enter a pattern to detect.';
                previewDiv.classList.remove('preview-result');
                previewDiv.classList.add('preview-error');
                return;
            }

            let value = null;
            if (valueType === "numeric") {
                const match = selectedMessage.match(new RegExp(`\\b${pattern}\\b\\s*(\\d+\\.?\\d*)`, 'i'));
                value = match ? match[1] : null;
            } else if (valueType === "binary") {
                value = selectedMessage.toLowerCase().includes(pattern) || selectedMessage.toLowerCase().includes('detected') ? "ON" : "OFF";
            }

            if (value !== null) {
                let unit = '';
                const units = {
                    "battery": "%", "voltage": "V", "temperature": "°C", "humidity": "%", "pressure": "hPa",
                    "distance": "m", "speed": "km/h", "angle": "°", "current": "A", "energy": "kWh", "power": "W",
                    "duration": "s", "timestamp": "", "illuminance": "lx", "signal_strength": "dBm", "power_factor": "",
                    "apparent_power": "VA", "reactive_power": "var", "gas": "m³", "volume": "L", "frequency": "Hz",
                    "carbon_dioxide": "ppm", "carbon_monoxide": "ppm", "nitrogen_dioxide": "ppm", "ozone": "ppm",
                    "sulphur_dioxide": "ppm", "pm1": "µg/m³", "pm10": "µg/m³", "pm25": "µg/m³",
                    "volatile_organic_compounds": "ppb", "nitrogen_monoxide": "ppm"
                };
                unit = units[deviceClass] || '';
                previewDiv.textContent = `Preview Value: ${value} ${unit}`;
                previewDiv.classList.remove('preview-error');
                previewDiv.classList.add('preview-result');
            } else {
                previewDiv.textContent = 'No value detected for the given pattern.';
                previewDiv.classList.remove('preview-result');
                previewDiv.classList.add('preview-error');
            }
        }

        // Trigger initial setup
        window.onload = function() {
            updateDeviceClassOptions(); // Set initial device class options
            if (document.getElementById('selected_message').value) {
                analyzeMessage();
                previewSensor();
            }
        };
    </script>
</body>
</html>
