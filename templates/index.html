<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meshtastic Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .table-container { margin-top: 20px; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #0d6efd; }
        input:checked + .slider:before { transform: translateX(26px); }
        .node-link { color: #0d6efd; text-decoration: none; }
        .node-link:hover { text-decoration: underline; }
        .status-box { margin-bottom: 20px; padding: 10px; border-radius: 5px; }
        .status-connected { background-color: #d4edda; color: #155724; }
        .status-disconnected { background-color: #f8d7da; color: #721c24; }
        .status-error { background-color: #fff3cd; color: #856404; }
        .clear-btn { margin-left: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Meshtastic Dashboard</h1>

        <!-- Navigation -->
        <div class="mb-3">
            <a href="{{ url_for('mqtt_settings') }}" class="btn btn-primary me-2">MQTT Settings</a>
            <a href="{{ url_for('logs') }}" class="btn btn-secondary">View Logs</a>
        </div>

        <!-- Status Indicators -->
        <div class="status-box {{ 'status-connected' if 'Connected' in bridge_status else 'status-error' if 'Error' in bridge_status else 'status-disconnected' }}">
            <strong>Bridge Status:</strong> {{ bridge_status }}
        </div>
        <div class="status-box {{ 'status-connected' if 'Connected' in mqtt_status else 'status-error' if 'Error' in mqtt_status else 'status-disconnected' }}">
            <strong>MQTT Status:</strong> {{ mqtt_status }}
        </div>

        <!-- Nodes Table -->
        <div class="table-container">
            <table class="table table-striped table-hover" id="nodes-table">
                <thead class="table-dark">
                    <tr>
                        <th>Node ID</th>
                        <th>Short Name</th>
                        <th>Long Name</th>
                        <th>Last Heard</th>
                        <th>Home Assistant</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="nodes-body">
                    {% for node_id in nodes.keys() %}
                    <tr>
                        <td><a href="{{ url_for('node_view', node_id=node_id) }}" class="node-link">{{ node_id }}</a></td>
                        <td>{{ node_info[node_id].short_name }}</td>
                        <td>{{ node_info[node_id].long_name }}</td>
                        <td>{{ last_heard[node_id] | strftime }}</td>
                        <td>
                            <label class="switch">
                                <input type="checkbox" name="toggle_ha" id="toggle_{{ node_id }}" 
                                       {% if node_id in enabled_nodes %}checked{% endif %} 
                                       onchange="toggleNode('{{ node_id }}')">
                                <span class="slider"></span>
                            </label>
                            <form id="ha_form_{{ node_id }}" method="post" style="display:none;">
                                <input type="hidden" name="node_id" value="{{ node_id }}">
                                <input type="hidden" name="toggle_ha" id="toggle_value_{{ node_id }}">
                            </form>
                        </td>
                        <td>
                            <form method="post" onsubmit="return confirm('Are you sure you want to clear node {{ node_id }}?');">
                                <input type="hidden" name="node_id" value="{{ node_id }}">
                                <input type="hidden" name="clear_node" value="1"> <!-- Added to match Flask route -->
                                <button type="submit" class="btn btn-danger btn-sm clear-btn">Clear Node</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const eventSource = new EventSource('/stream');
        const nodes = {};
        let initialLoad = true;

        function updateNode(nodeId, data) {
            if (!nodes[nodeId]) {
                nodes[nodeId] = { id: nodeId, short_name: '', long_name: '', last_heard: 0, enabled: false };
            }
            nodes[nodeId] = { ...nodes[nodeId], ...data };
            const row = document.querySelector(`#nodes-table tr td a[href="/node/${nodeId}"]`)?.closest('tr');
            if (row) {
                row.querySelector('td:nth-child(2)').textContent = data.short_name || nodes[nodeId].short_name;
                row.querySelector('td:nth-child(3)').textContent = data.long_name || nodes[nodeId].long_name;
                row.querySelector('td:nth-child(4)').textContent = new Date(data.last_heard * 1000).toLocaleString();
                const checkbox = row.querySelector(`#toggle_${nodeId}`);
                const hiddenInput = row.querySelector(`#toggle_value_${nodeId}`);
                if (checkbox) {
                    checkbox.checked = data.enabled || nodes[nodeId].enabled;
                    hiddenInput.value = checkbox.checked ? 'on' : 'off';
                }
            } else if (!initialLoad) {
                addNewNodeRow(nodeId, data);
            }
        }

        function addNewNodeRow(nodeId, data) {
            const tbody = document.getElementById('nodes-body');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><a href="/node/${nodeId}" class="node-link">${nodeId}</a></td>
                <td>${data.short_name || ''}</td>
                <td>${data.long_name || ''}</td>
                <td>${new Date(data.last_heard * 1000).toLocaleString()}</td>
                <td>
                    <label class="switch">
                        <input type="checkbox" name="toggle_ha" id="toggle_${nodeId}" 
                               ${data.enabled ? 'checked' : ''} 
                               onchange="toggleNode('${nodeId}')">
                        <span class="slider"></span>
                    </label>
                    <form id="ha_form_${nodeId}" method="post" style="display:none;">
                        <input type="hidden" name="node_id" value="${nodeId}">
                        <input type="hidden" name="toggle_ha" id="toggle_value_${nodeId}" value="${data.enabled ? 'on' : 'off'}">
                    </form>
                </td>
                <td>
                    <form method="post" onsubmit="return confirm('Are you sure you want to clear node ${nodeId}?');">
                        <input type="hidden" name="node_id" value="${nodeId}">
                        <input type="hidden" name="clear_node" value="1"> <!-- Added to match Flask route -->
                        <button type="submit" class="btn btn-danger btn-sm clear-btn">Clear Node</button>
                    </form>
                </td>
            `;
            tbody.appendChild(row);
        }

        function toggleNode(nodeId) {
            const checkbox = document.getElementById(`toggle_${nodeId}`);
            const hiddenInput = document.getElementById(`toggle_value_${nodeId}`);
            const enabled = checkbox.checked;
            hiddenInput.value = enabled ? 'on' : 'off';
            nodes[nodeId].enabled = enabled;

            fetch(`/toggle/${nodeId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ toggle_ha: enabled ? 'on' : 'off' })
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      console.log(`Toggled ${nodeId} to ${enabled ? 'enabled' : 'disabled'}`);
                  } else {
                      checkbox.checked = !enabled; // Revert on failure
                      hiddenInput.value = !enabled ? 'on' : 'off';
                      nodes[nodeId].enabled = !enabled;
                  }
              }).catch(error => {
                  console.error('Toggle failed:', error);
                  checkbox.checked = !enabled; // Revert on error
                  hiddenInput.value = !enabled ? 'on' : 'off';
                  nodes[nodeId].enabled = !enabled;
              });
        }

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.nodes) {
                Object.entries(data.nodes).forEach(([nodeId, nodeData]) => {
                    updateNode(nodeId, nodeData);
                });
            }
            if (initialLoad) initialLoad = false;
        };

        eventSource.onerror = function() {
            console.log('EventSource failed, attempting reconnect...');
            eventSource.close();
            setTimeout(() => {
                eventSource = new EventSource('/stream');
            }, 1000);
        };

        // Initial load from server-rendered data
        document.querySelectorAll('#nodes-body tr').forEach(row => {
            const nodeId = row.querySelector('td a').textContent;
            nodes[nodeId] = {
                id: nodeId,
                short_name: row.querySelector('td:nth-child(2)').textContent,
                long_name: row.querySelector('td:nth-child(3)').textContent,
                last_heard: new Date(row.querySelector('td:nth-child(4)').textContent).getTime() / 1000,
                enabled: row.querySelector('input[type="checkbox"]').checked
            };
        });
    </script>
</body>
</html>